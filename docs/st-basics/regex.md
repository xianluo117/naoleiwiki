# 🔍 SillyTavern 正则 (Regex) 功能

正则是 SillyTavern 的默认扩展之一，作用是通过正则表达式查找文本中的特定部分，一旦匹配就会立刻执行替换。

::: warning ⚠️ 注意
调整开关正则时，务必在 **新对话** 中进行。由于酒馆 BUG，开关正则可能导致当前聊天记录丢失。
:::

---

## 配置项说明

### 基本设置

| 配置项             | 说明                                                                 |
| ------------------ | -------------------------------------------------------------------- |
| **脚本名称**       | 正则的名称，不影响运作                                               |
| **查找正则表达式** | 用于遍历文本中特定格式的查找表达式                                   |
| **替换为**         | 用于替换捕获组中的字符，可使用 `$1`、`$2` 等代替指定捕获组           |
| **修剪掉**         | 修剪捕获组中的字符元素。例如捕获组为 `1234`，填写 `1` 后结果为 `234` |

### 作用范围

正则的作用域，可以多选以下项目：

| 范围         | 说明                                                   |
| ------------ | ------------------------------------------------------ |
| **用户输入** | 聊天记录中角色为 user 的内容（即用户输入给 AI 的内容） |
| **AI 输出**  | 聊天记录中角色为 char 的内容（即 AI 返回的内容）       |
| **快捷命令** | 使用酒馆斜杠命令插入到提示词的内容                     |
| **世界信息** | 世界书的内容 ⚠️ 启用此项时必须勾选「仅格式提示词」      |
| **推理**     | AI 返回的推理内容（思维链）                            |

### 其他选项

| 选项             | 说明                                     |
| ---------------- | ---------------------------------------- |
| **已禁用**       | 禁用该正则                               |
| **在编辑时运行** | 消息被手动编辑后，该正则会再次查找和替换 |

---

## 正则表达式查找时的宏处理

控制正则表达式查找之前，是否将酒馆宏（如 `{{user}}`）替换为其他内容：

| 模式             | 说明                                                             |
| ---------------- | ---------------------------------------------------------------- |
| **不替换**       | 正则将完全忽略酒馆宏                                             |
| **替换（原始）** | 将酒馆宏按原始形态（如 `{{user}}`）来查找和替换                  |
| **替换（转义）** | 在每个字符前添加正则转义斜杠 `\`，确保不会意外改变正则表达式序列 |

---

## 短暂（Transient）设置

「短暂」选项控制正则的生效范围，不同组合有不同效果：

| 仅格式显示 | 仅格式提示词 | 效果                                                 |
| :--------: | :----------: | ---------------------------------------------------- |
|     ✅      |      ❌       | 只改变用户看到的内容，不改变聊天记录和 AI 提示词     |
|     ❌      |      ✅       | 只改变提示词中的内容，不改变聊天记录和用户看到的内容 |
|     ✅      |      ✅       | 同时改变用户和 AI 看到的内容，但聊天记录文件不变     |
|     ❌      |      ❌       | 直接修改聊天记录文件                                 |

::: danger ⚠️ 重要
两个都不勾选时，正则将 **直接修改聊天记录文件**，操作不可逆。
:::

---

## 深度设置

深度设置控制正则对哪些「楼层」生效：

| 设置         | 说明                           |
| ------------ | ------------------------------ |
| **最大深度** | 正则只对该深度及以下的楼层生效 |
| **最小深度** | 只对该深度及以上的楼层生效     |

::: info 💡 深度计算方式
一条用户或 AI 消息为一个楼层。**最靠近当前**（最「靠下」）的为第 1 层，上方是第 2 层……

这与楼层计数（从第一条消息为第 0 层开始递增）是 **相反的**。
:::

---

::: info 📖 相关阅读

- [斜杠命令](./slash-commands.md) — ST 常用斜杠命令
- [酒馆使用问题](/faq/st-usage) — 预设参数和正则使用常见问题
:::
