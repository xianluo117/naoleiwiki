# 🍺 酒馆使用问题

本页面收录 SillyTavern（酒馆）日常使用中的常见问题及解决方案。

---

## 预设与参数

### 怎么缝预设？怎么自定义预设？

1. 准备好要放进原本预设的提示词，复制到剪贴板
2. 打开 SillyTavern 的预设页面，向下滑，直到看到很多可以开关的预设条目。在这些条目的上方，有一个「提示词」的下拉选框，右边分别是「锁链」按钮、删除按钮、导入/导出、刷新和新增
3. 点击最右边的 **新增按钮**，将你准备好的提示词放进去，取一个你喜欢的标题，然后点击编辑框右下角的保存按钮。这样就创建了一个新的预设条目
4. 在提示词的下拉选框中，找到你刚刚放进去的条目，选择它，然后点击选框右侧的 **锁链按钮**。条目会被插入到整个提示词列表的顶端
5. **拖拽** 刚刚插入的提示词条目到合适的位置。例如你新建了一个「文风」，就把它放到原本预设的「文风」部分里
6. ⚠️ **重要！** 做完所有操作后，回到整个预设页面最上方，点击预设名字旁边的 **保存按钮**！否则所有修改都会消失

---

### 预设中那些参数和可以开关的条目都有什么用？

#### 基础参数

| 参数                           | 说明                                                                                                   |
| ------------------------------ | ------------------------------------------------------------------------------------------------------ |
| **上下文**                     | 当前发送给 AI 的所有信息总和，包括角色设定、世界书、聊天记录等                                         |
| **上下文长度（以词符数计）**   | 决定 AI 的「记忆」容量。超过此数值时，酒馆会自动不发送最早的聊天记录。通常保持预设作者推荐的默认值即可 |
| **最大回复长度（以词符数计）** | 设定 AI 单次回复的最大字数。建议使用预设作者给的默认值                                                 |
| **流式传输**                   | 开启后 AI 的回复会像打字一样逐字显示                                                                   |
| **总词符数**                   | 显示在预设条目列表上方，告诉你如果再发一条消息需要使用多少上下文                                       |

::: warning ⚠️ 流式传输注意
使用 AI Studio API 的 Gemini 模型时，**必须关闭** 流式传输。否则实时审查机制非常容易导致回复在输出中途被截断。
:::

::: tip 💡 总词符数参考
- Gemini 2.5 Pro：100k 已经很多了
- Gemini 3.0 Pro：40k 就已经很多了

降低总词符数请参考后文「总结方法」部分。
:::

#### 预设条目说明

| 条目                   | 说明                                                                                                                                           |
| ---------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| **头部**               | 预设最顶部的几个条目，多用于定义 AI 的核心角色身份。⚠️ 部分 API 提供方（如谷歌）会「标记」预设头部，可能导致回复变慢、无法破限、无限 429 报错等 |
| **防 429**             | 在预设头部之前的一段包含随机宏的「乱码」，用于绕过对头部的标记，有效果但不大                                                                   |
| **思维链**             | 要求 AI 在正式回复前先进行「思考」并输出思考过程。一般以「思维链开始」「思维链结束」两个条目标识范围。对正文影响较大                           |
| **文风**               | 指导 AI 写作风格，对正文影响巨大                                                                                                               |
| **禁词/反八股**        | 尝试阻止 AI 使用特定词汇或表达方式。效果不好是正常的                                                                                           |
| **防绝望/黑化/阴谋论** | 避免 AI 让角色轻易陷入负面情绪或极端思维                                                                                                       |
| **小 COT/段前思考**    | 在正文段落间插入微型思维链，常用于精细调整文风或抗绝望                                                                                         |
| **防抢话**             | 防止 AI 代替你（用户/User/主控）进行描述或做出决定。⚠️ 启用时必须调低预设条目内的字数控制                                                       |
| **反截断**             | 帮助绕过审查生成完整回复。回复正常时请勿开启。从简单的开始尝试，同时只能开一个                                                                 |
| **小总结/摘要**        | 让 AI 在每次回复后附加摘要。配合正则功能可节约上下文空间。⚠️ 只对开启后新生成的回复生效，必须与对应的正则功能一同开启或关闭                     |
| **字数控制**           | 要求 AI 的回复达到或不超过特定字数。AI 并不真的知道自己写了多少字，要求不可能被严格遵守                                                        |
| **总结前文**           | 也称「大总结」，开启后命令 AI 暂停角色扮演，仅对之前的全部对话进行全面总结                                                                     |
| **底部**               | 位于预设最下方的条目，多用于卡思维链、重申用户输入、引导 AI 开始回复等。除非你知道自己在干什么，否则不要随意修改                               |

::: details 💡 「卡思维链」是什么？
让 AI 以为模型自带的思考已经结束了，以立刻开始以预设思维链进行思考（或者干脆不思考）。
:::

---

## 总结与上下文管理

### 如何正确地总结之前的聊天记录（总结方法）

#### 方法一：手动总结

1. 使用 `/hide` 命令隐藏大部分聊天记录（如 `/hide 0-100` 隐藏前 100 条）
2. 使用 `/unhide` 命令分段显示记录（如 `/unhide 0-50`），然后让 AI 对显示部分进行总结：
   - 若预设中有「大总结」或「总结前文」条目，将其打开，然后发送指令：
   ```
   <Request:暂停剧情，本回合无需输出正文内容。请将之前发生的事进行总结，按时间或逻辑顺序保留关键信息，省略冗余描述>
   ```
   - 若没有，直接发送指令即可
3. 将 AI 生成的总结内容保存到 **世界书** 中。建议的条目设置为：
   - 触发方式：🔵 蓝灯（总结内容将在每次生成中都被发送）
   - 位置：`@D ⚙️`
   - 深度：填写 `9999`
   - 记得打开此条目
4. 重复此过程，直到所有聊天记录都已总结完毕，总结内容全部保存到上一步中创建的世界书条目中
5. 最后，隐藏所有前文，只保留最近的 5-10 条以维持文风

::: warning ⚠️ 注意
使用 `/hide` 和 `/unhide` 时，起始和结束楼层 **不可超出** 当前已有的楼层范围，否则命令无效。
:::

#### 方法二：调整上下文长度

如果不在乎丢失早期的对话记忆，可以直接在预设页面中将最大上下文长度限制为模型上限（如 125000）。SillyTavern 会自动去除最早的聊天记录以保持上下文长度不超过限制。

---

## 角色卡与聊天记录

### 导入角色卡失败

**现象**：提示 `The file is likely invalid or corrupted`

**原因**：图片中用于存放角色卡内容的元数据不存在或被破坏。原因可能有：
- 用户下载了错误的图片
- 角色卡作者上传的文件被平台（如 Discord）压缩

**解决**：检查图片格式是否为 PNG。若否，**必须重新下载正确的文件**，绝不能试图将其他格式的图片转换为 PNG，因为它们的元数据已丢失。

---

### 聊天记录丢失了，怎么找回？

1. 前往路径：`(SillyTavern文件夹)/data/default-user/backups`
   - 如果使用多用户模式，将 `default-user` 换成用户名
2. 将文件夹内的所有文件按「修改时间」倒序排列，观察文件大小变化。通常会发现有某一时刻文件大小突然变小，该「小文件」下方的「大文件」即为丢失前的聊天记录
3. 复制找到的「大文件」，粘贴到：`(SillyTavern文件夹)/data/default-user/chats/(角色卡名)` 文件夹下
   - 如果不确定粘贴位置，可在酒馆内操作：点击聊天输入框左侧的三条横线 → 选择「管理聊天文件」→「导入聊天」，选择找到的聊天文件并导入

---

### 怎么正确更新角色卡？

1. 先点击角色卡界面的 **绿色小地球** 按钮，跳转到角色卡绑定的世界书
2. **删除** 当前的世界书。删除成功后，角色卡界面的绿色小地球会变成白色
3. 点击「更多」中的 **替换/更新**，选择新版的角色卡文件。此时酒馆会导入新版的世界书
4. 酒馆应该会自动将新版世界书绑定到角色卡上（表现为小地球变绿）。如果没有变绿，需要自行点击白色的小地球按钮，选择刚刚导入的世界书进行绑定

---

## 基本操作

### 怎么开启新聊天？切换/删除聊天记录？删除消息？重新生成？

分别使用「开始新聊天」「管理聊天文件」「删除消息」「重新生成」按钮。这些按钮都位于 ST 输入框左侧的 **三条横线** 菜单中。

---

### 怎么编辑聊天记录中已有的消息？

使用 **小铅笔** 按钮。这个按钮位于消息右上角，形状是一个铅笔。点击它，消息会变成一个包含内容的编辑框，编辑后点击绿色对号按钮即可保存。

---

## 扩展与插件

### 怎么安装扩展？

1. 找到扩展作者给的 GitHub 链接（或其他类似平台的链接）
2. 打开 SillyTavern 的扩展页面（上面一排按钮中，图标是三个箱子的那个）
3. 点击「安装扩展」并填入 GitHub 链接
4. 点击「为自己安装」

---

### 「酒馆助手」怎么安装？

🔗 [酒馆助手文档](https://n0vi028.github.io/JS-Slash-Runner-Doc/)

---

### 「提示词模板」怎么安装？

🔗 [提示词模板 GitHub](https://github.com/zonde306/ST-Prompt-Template/)

---

### 怎么下载 ST 使用的预设？

1. 打开 Discord 社区的预设区
2. 可以按标签筛选，选择自己玩的模型，挑自己喜欢的预设下载。每个预设风格都不同，可以都试试，找到最适合自己的
3. 作者一般会给 **预设文件 + 正则文件**（文件大小大的一般是预设，小的是正则），全部下载下来
4. 在酒馆中导入：
   - **预设文件** → 导入到预设（上面一排按钮最左边那个）
   - **正则文件** → 导入到扩展 → 正则

::: warning ⚠️ 重要
预设必须和对应的正则配合使用——用哪个预设就开对应的正则，其他预设的正则要关掉。

调整开关正则时，务必在 **新对话** 中进行，由于酒馆 BUG，开关正则可能导致当前聊天记录丢失。
:::

---

## 常见故障

### JavaScript heap out of memory

**原因**：酒馆尝试使用的内存超过了最大分配限额。在 1.13.4 及更早版本中，由于漏洞会出现周期性内存使用尖峰

**解决**：使用 KKTsN 制作的一键魔改脚本 **Foxium**：[下载链接](https://discord.com/channels/1134557553011998840/1455186201228349586)，可以提高内存上限并修复旧版本漏洞

::: tip 💡 备注
对于 Termux 环境使用一键安装脚本的用户，Foxium 中修改内存上限的功能可能无效，但禁用周期检查来降低内存使用的方法依然有效。
:::

---

### mandatory prompt exceeds the content size

**原因**：当前聊天尝试发送的提示词长度超出了预设中设置的「上下文长度」

**解决**：将「预设」中的「上下文长度」调整到模型支持的上限。若还是不能解决，刷新网页或重启酒馆

---

### Check the server connection / ST Server cannot be reached

**现象**：
- `Check the server connection and reload the page to prevent data loss`
- `ST Server cannot be reached. Verify that the server is running and accessible`
- 同时无法进行任何操作

**原因**：运行酒馆的浏览器与终端连接断开

**解决**：重启酒馆即可。在安卓使用 Termux 运行酒馆时，必须保持后台（Termux）不被系统限制活动，方法有「挂小窗」等

---

### AI 回复的内容变成一大段五颜六色的代码

**解决**：
1. 检查是否安装「酒馆助手」扩展，或者其他角色卡作者要求安装的扩展
2. 若已安装，检查「渲染器」功能和「启用渲染优化」是否打开，若否，将其打开

---

### 红框报错「An unknown error occurred while counting tokens」

**解决**：先重启酒馆，还不行的话直接删除出现此问题的角色卡并重新导入

---

### 酒馆变得很卡

**原因**：加载的消息过多 / 消息包含大量 HTML 美化内容 / 正则处理的消息太多

**解决**：
1. 先重启酒馆（后台也要关掉重开），确认卡顿不是偶然问题
2. 调低「用户设置」中的「要加载 # 条消息」
3. 使用去除前文消息的正则，屏蔽距当前太远的聊天记录（这个正则应该放在所有其他正则的上面，请在类脑社区寻找具体的正则文件）
4. 检查是否开了很多多余的正则，关掉
5. 如果用了「提示词模板」扩展，更新一下这个扩展，老版本有性能问题
6. 如果是有大量美化的角色卡变得很卡，调低「酒馆助手」扩展的「渲染器」中的渲染深度，建议调低至 2

---

### 酒馆启动后进入很慢

**解决**：
- `config.yaml` 中，将 `lazyLoadCharacters` 设置为 `true`
- 关闭用户设置中的「自动加载上次聊天」
- 清除浏览器缓存或更换浏览器

---

### HTML 美化（状态栏/前端等）出现两次

**原因**：启用了多个可以渲染 HTML 代码块的插件

**解决**：目前最常见的两个渲染插件是「酒馆助手」和「小白 X」，关掉其中一个的渲染器功能即可

---

### 大量红框报错「没有记录载体」

**解决**：禁用和「记忆表格」「知识库」等相关的插件

---

### 云酒馆无法保存聊天记录和设置

**原因**：Nginx 分发的酒馆，聊天记录在超过 1024KB 时会报错，因为 Nginx 默认配置文件只允许上传 1MB 大小的文件

**解决**：到酒馆分发的 Nginx 配置文件，在 `server` 块加入：

```nginx
client_max_body_size 10m;
client_header_timeout 2m;
client_body_timeout 2m;
proxy_connect_timeout 2m;
proxy_read_timeout 2m;
proxy_send_timeout 2m;
```

然后执行 `nginx -t` 检查配置文件是否正确，无误后 `systemctl restart nginx` 重启 Nginx 服务

---

### 选择全局世界书处异常

**现象**：同时展示所有世界书（无论有没有启用），且无法正常选择

**原因**：新版本酒馆和部分浏览器的兼容性 BUG

**解决**：回退浏览器版本或更换浏览器

---

::: info 📖 相关阅读
- [斜杠命令](/st-basics/slash-commands) — ST 常用斜杠命令
- [正则功能](/st-basics/regex) — 正则表达式详解
- [文件结构](/st-basics/file-structure) — ST 目录结构
- [报错对照表](/troubleshooting/) — 各渠道报错解决方案
:::
